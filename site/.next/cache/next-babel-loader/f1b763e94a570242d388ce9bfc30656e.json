{"ast":null,"code":"import { Editor, Range, Path, Transforms } from 'slate';\nimport { fixList } from \"./util\";\nexport const onKeyDown = () => (e, editor) => {\n  let {\n    selection\n  } = editor;\n  if (!selection) return;\n\n  if (e.key === 'Tab') {\n    e.preventDefault();\n    onTab(editor); // Editor.insertText(editor,'\\t')\n  }\n};\nexport const onTab = editor => {\n  Editor.withoutNormalizing(editor, () => {\n    const selection = editor.selection;\n    const entry = Editor.above(editor, {\n      match: n => Editor.isBlock(editor, n)\n    });\n\n    if (!entry) {\n      return;\n    }\n\n    if (entry[0].type == 'list-item') {\n      if (Range.isCollapsed(selection)) {\n        const path = entry[1];\n        const start = Editor.start(editor, path);\n        const range = {\n          anchor: selection.anchor,\n          focus: start\n        };\n        let beforeText = Editor.string(editor, range);\n\n        if (beforeText.length) {\n          Editor.insertText(editor, '    ');\n          return;\n        }\n      } // // move down with tab\n      // const tab = !e.shiftKey;\n      // if (tab) {\n\n\n      moveListItemDown(editor, entry[1]);\n      fixList(editor); // }\n    } else {\n      let p = selection.anchor;\n\n      if (Range.isExpanded(selection)) {\n        p = Editor.start(editor, p.path);\n      }\n\n      const ref = Editor.rangeRef(editor, selection);\n      Transforms.select(editor, p);\n      Editor.insertText(editor, '    ');\n      Transforms.select(editor, ref.unref());\n    }\n  });\n};\n\nfunction moveListItemDown(editor, path) {\n  let entry = Editor.parent(editor, path);\n  let node = entry[0];\n\n  if (!node.type.endsWith('-list')) {\n    throw new Error(`moveListItemDown, not a list at: ${entry[1]}`);\n  }\n\n  let ref = Editor.pathRef(editor, path);\n  let pre = Editor.previous(editor, {\n    at: path\n  });\n  let next = Editor.next(editor, {\n    at: path\n  });\n\n  if (pre) {\n    Transforms.splitNodes(editor, {\n      at: path\n    });\n  }\n\n  if (next) {\n    Transforms.splitNodes(editor, {\n      at: Path.next(ref.current)\n    });\n  }\n\n  path = ref.unref();\n  const indent = node.indent ? node.indent + 1 : 1;\n  Transforms.setNodes(editor, {\n    indent\n  }, {\n    at: Path.parent(path)\n  });\n}","map":{"version":3,"sources":["/Users/yonggu/WebstormProjects/gyedit/src/onKeyDown.ts"],"names":["Editor","Range","Path","Transforms","fixList","onKeyDown","e","editor","selection","key","preventDefault","onTab","withoutNormalizing","entry","above","match","n","isBlock","type","isCollapsed","path","start","range","anchor","focus","beforeText","string","length","insertText","moveListItemDown","p","isExpanded","ref","rangeRef","select","unref","parent","node","endsWith","Error","pathRef","pre","previous","at","next","splitNodes","current","indent","setNodes"],"mappings":"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","sourcesContent":["import {Editor, Range, Path, Location, Transforms} from 'slate'\nimport {ListNode} from './types'\nimport {fixList} from \"./util\";\n\n\nexport const onKeyDown = () => (\n    e: React.KeyboardEvent<HTMLDivElement>,\n    editor: Editor\n) => {\n    let {selection} = editor\n    if (!selection) return\n    if (e.key === 'Tab') {\n        e.preventDefault()\n        onTab(editor)\n        // Editor.insertText(editor,'\\t')\n    }\n};\nexport const onTab = (editor: Editor): void => {\n    Editor.withoutNormalizing(editor, () => {\n        const selection = editor.selection!\n        const entry = Editor.above(editor, {\n            match: n => Editor.isBlock(editor, n),\n        })\n        if (!entry) {\n            return\n        }\n        if (entry[0].type == 'list-item') {\n            if (Range.isCollapsed(selection)) {\n                const path = entry[1]\n                const start = Editor.start(editor, path)\n                const range = {anchor: selection.anchor, focus: start}\n                let beforeText = Editor.string(editor, range)\n                if (beforeText.length) {\n                    Editor.insertText(editor, '    ')\n                    return\n                }\n            }\n            // // move down with tab\n            // const tab = !e.shiftKey;\n            // if (tab) {\n            moveListItemDown(editor, entry[1]);\n            fixList(editor)\n            // }\n        } else {\n            let p: Location = selection.anchor\n            if (Range.isExpanded(selection)) {\n                p = Editor.start(editor, p.path)\n            }\n            const ref = Editor.rangeRef(editor, selection)\n            Transforms.select(editor, p)\n            Editor.insertText(editor, '    ')\n            Transforms.select(editor, ref.unref()!)\n        }\n    })\n}\n\nfunction moveListItemDown(editor: Editor, path: Path) {\n    let entry = Editor.parent(editor, path) as [ListNode, Path]\n    let node = entry[0]\n    if (!node.type.endsWith('-list')) {\n        throw new Error(`moveListItemDown, not a list at: ${entry[1]}`)\n    }\n    let ref = Editor.pathRef(editor, path)\n    let pre = Editor.previous(editor, {at: path})\n    let next = Editor.next(editor, {at: path})\n    if (pre) {\n        Transforms.splitNodes(editor, {at: path})\n    }\n    if (next) {\n        Transforms.splitNodes(editor, {at: Path.next(ref.current!)})\n    }\n    path = ref.unref()!\n    const indent = node.indent ? node.indent + 1 : 1\n    Transforms.setNodes(editor, {indent}, {at: Path.parent(path)})\n\n\n}"]},"metadata":{},"sourceType":"module"}